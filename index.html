<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
  </head>
  <body>
    <!-- file upload -->
    <input type="file" id="imageLoader" name="imageLoader"/>
    <label>Image File:</label><br/>
    <canvas id="canvas" width="600" height="600"></canvas>

    <!-- video -->
    <video playsinline autoplay></video>
    <button>Take snapshot</button>

    <!-- Note the usage of `type=module` here as this is an ES6 module -->
    <script type="module">
        import { run, grayscale, changeColour, crazyColour, rustImage } from "./toolbox.js"
        run(); // load wasm

        // upload image
var imageLoader = document.getElementById('imageLoader');
imageLoader.addEventListener('change', handleImage, false);
var ctx = canvas.getContext('2d');

const video = document.querySelector('video');
const button = document.querySelector('button');

function processFrame() {
  /* set the canvas to the dimensions of the video feed */
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  /* make the snapshot */
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    //extra
    let image = new Image();
    image.src = canvas.toDataURL();
    ctx.drawImage(image, 0, 0);
    let imageData = ctx.getImageData(0, 0, canvas.width -1, canvas.height - 1);
    imageData = ctx.getImageData(0, 0, canvas.width-1, canvas.height-1);
    let new_data_from_rust = rustImage(imageData);
    const width = Math.max(1, Math.floor(imageData.width));
    const height = Math.max(1, Math.floor(imageData.height));
    const newImageData = new ImageData(new_data_from_rust, width, height);
    ctx.putImageData(newImageData, 0, 0);
    if (videoOn === true)
        window.requestAnimationFrame(processFrame);
};

var videoOn = false;
var localStream;
function flipVideoFeed() {
    if (videoOn === false) {
        navigator.mediaDevices.getUserMedia( {audio: false, video: true })
            .then((stream) => {video.srcObject = stream; localStream = stream;})
            .then(window.requestAnimationFrame(processFrame))
            .catch(error => console.error(error));
        videoOn = true;
    } else {
        localStream.getTracks()[0].stop();
        videoOn = false;
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    }
}

button.onclick = flipVideoFeed;

function handleImage(e){
    var reader = new FileReader();
    const img = new Image();
    reader.onload = function(event){
        img.src = event.target.result;
        img.onload = () => {
            ctx.drawImage(img, 0, 0);
            let imageData = ctx.getImageData(0, 0, canvas.width -1, canvas.height - 1);
            imageData = crazyColour(imageData)
            ctx.putImageData(imageData, 0, 0);
        }   
    }   
    reader.readAsDataURL(e.target.files[0]);
}   


    </script>
  </body>
</html>
